---
output: 
  word_document:
    reference_docx: !expr system.file("rmd", "template.docx", package = "MassWateR")
params: 
  res: res
  acc: acc 
  frecom: frecom
  rawdata: rawdata
  dqofontsize: dqofontsize 
  tabfontsize: tabfontsize
  warn: warn
  runchk: runchk
---

```{r setup, echo = F}
knitr::opts_chunk$set(echo = FALSE, ft.keepnext = F, warning = TRUE)
suppressWarnings(suppressMessages(library(MassWateR, warn.conflicts = FALSE, quietly = TRUE)))
suppressWarnings(suppressMessages(library(dplyr, warn.conflicts = FALSE, quietly = TRUE)))
suppressWarnings(suppressMessages(library(flextable, warn.conflicts = FALSE, quietly = TRUE)))
suppressWarnings(suppressMessages(library(lubridate, warn.conflicts = FALSE, quietly = TRUE)))

# user parameters
warn <- params$warn
dqofontsize <- params$dqofontsize
tabfontsize <- params$tabfontsize
res <- params$res
acc <- params$acc
frecom <- params$frecom

set_flextable_defaults(font.size = tabfontsize, padding = 0)

dt <- format(Sys.Date(), "%B %d, %Y") 

# get input 
inp <- utilMWRinput(res = res, acc = acc, frecom = frecom, runchk = runchk, warn = warn)
resdat <- inp$resdat
accdat <- inp$accdat
frecomdat <- inp$frecomdat

resdatdt <- range(resdat$`Activity Start Date`)
resdatdt <- paste(month(resdatdt), day(resdatdt), year(resdatdt), sep = '/') %>% 
  paste(collapse = ' to ')

# globals
wd <- 6.5
fontname <- 'Calibri (Body)'

# dqo table theme
thmdqo <- function(x, fontname, dqofontsize){
  flextable::colformat_double(x, na_str = '-') %>% 
    flextable::colformat_char(na_str = '-') %>% 
    flextable::border_inner() %>% 
    flextable::align(align = 'center', part = 'all') %>% 
    flextable::align(align = 'left', j = 1, part = 'all') %>% 
    flextable::fontsize(size = dqofontsize, part = 'all') %>% 
    flextable::padding(padding = 0, part = 'all') %>% 
    flextable::font(fontname = fontname, part = 'all')
}

# dqo summary table theme
thmsum <- function(x, wd, fontname){
  flextable::width(x, width = wd / ncol_keys(x)) %>% 
    flextable::font(fontname = fontname, part = 'all')
}

# notes table
notes <- function(wd, fontname){
  
  tab <- data.frame(
    x = c('Notes:', NA, NA)
  )

  flextable::flextable(tab) %>% 
    flextable::align(align = 'left', part = 'all') %>%
    flextable::border_remove() %>%
    flextable::width(width = wd) %>% 
    flextable::hline(i = 2:3, part = 'body') %>%
    flextable::padding(padding = 1.5, part = 'all') %>% 
    flextable::delete_part(part = 'header') %>%
    flextable::font(fontname = fontname, part = 'all') %>% 
    flextable::fontsize(size = 11, part = 'all') 
  
}
```

# QC Review

## Organization Name

<br>

```{r, ft.align = 'left'}
tab <- data.frame(
  x = c(dt, 'Prepared by:', 'QAPP version:'),
  y = c(NA, NA, NA)
)

flextable::flextable(tab) %>% 
  flextable::align(align = 'left', j = c(1, 2), part = 'all') %>%
  flextable::border_remove() %>%
  flextable::width(j = 1, width = 1.2) %>% 
  flextable::width(j = 2, width = 3) %>% 
  flextable::hline(i = 2:3, j = 2, part = 'body') %>%
  flextable::padding(padding = 1.5, part = 'all') %>% 
  flextable::delete_part(part = 'header') %>%
  flextable::font(fontname = fontname, part = 'all') %>% 
  flextable::fontsize(size = 11, part = 'all') 
```

<br>

### Data Quality Objectives

<br>

```{r}
frecomdat %>% 
  dplyr::mutate_if(is.numeric, as.character) %>% 
  flextable::flextable() %>% 
  thmdqo(fontname = fontname, dqofontsize = dqofontsize) %>%
  flextable::width(width = wd / ncol(frecomdat)) %>% 
  flextable::add_header_row(value = c('', 'Frequency %', ''), colwidths = c(1, 5, 1))
```

<br>

```{r}
accdat %>% 
  dplyr::mutate_if(is.numeric, as.character) %>%   
  flextable::flextable() %>% 
  thmdqo(fontname = fontname, dqofontsize = dqofontsize) %>% 
  flextable::width(width = 1, j = 1) %>% 
  flextable::width(width = (wd -1) / (ncol_keys(.) - 1), j = 2:ncol_keys(.)) 
```

<br>

```{r}
notes(wd, fontname)
```

\newpage

### QC Frequencies for `r resdatdt`

<br>

```{r}
tabMWRfre(res = resdat, frecom = frecomdat, type = 'summary', warn = warn) %>% 
  thmsum(wd = wd, fontname = fontname)
```

<br>

```{r}
notes(wd, fontname)
```

<br>

```{r}
tabMWRfre(res = resdat, frecom = frecomdat, type = 'percent', warn = warn) %>% 
  thmsum(wd = wd, fontname = fontname)
```

\newpage

### QC Accuracy Summary for `r resdatdt`

<br>

```{r}
tabMWRacc(res = resdat, acc = accdat, type = 'summary', warn = warn, frecom = frecomdat) %>% 
  thmsum(wd = wd, fontname = fontname)
```

<br>

```{r}
notes(wd, fontname)
```

<br>

```{r}
tabMWRacc(res = resdat, acc = accdat, type = 'percent', warn = warn, frecom = frecomdat) %>% 
  thmsum(wd = wd, fontname = fontname)
```

\newpage

### Data Completeness for `r resdatdt`

<br>

```{r, warning = T}
tabMWRcom(res = resdat, frecom = frecomdat, warn = warn, noteswd = 2) %>% 
  flextable::width(width = (wd - 2) / (ncol_keys(.) - 1), j = 1:(ncol_keys(.) -1)) %>%
  flextable::font(fontname = fontname, part = 'all')
```

<br>

```{r}
notes(wd, fontname)
```

`r if(rawdata){"\\newpage"}`

`r if(rawdata){paste0("### QC Raw Data for ", resdatdt, "\n<br>")}`

`r if(rawdata){"#### Field Blanks\n"}`

```{r, eval = rawdata}
tabMWRacc(res = resdat, acc = accdat, type = 'individual', accchk = 'Field Blanks', warn = warn, caption = FALSE) %>% 
  thmsum(wd = wd, fontname = fontname)
```

`r if(rawdata){"<br>"}`

```{r, eval = rawdata}
notes(wd, fontname)
```

`r if(rawdata){"<br>"}`

`r if(rawdata){"#### Lab Blanks\n"}`

```{r, eval = rawdata}
tabMWRacc(res = resdat, acc = accdat, type = 'individual', accchk = 'Lab Blanks', warn = warn, caption = FALSE) %>% 
  thmsum(wd = wd, fontname = fontname)
```

`r if(rawdata){"<br>"}`

```{r, eval = rawdata}
notes(wd, fontname)
```

`r if(rawdata){"<br>"}`

`r if (rawdata){"#### Field Duplicates\n"}`

```{r, eval = rawdata}
tabMWRacc(res = resdat, acc = accdat, type = 'individual', accchk = 'Field Duplicates', warn = warn, caption = FALSE) %>% 
  thmsum(wd = wd, fontname = fontname)
```

`r if(rawdata){"<br>"}`

```{r, eval = rawdata}
notes(wd, fontname)
```

`r if(rawdata){"<br>"}`

`r if(rawdata){"#### Lab Duplicates\n"}`

```{r, eval = rawdata}
tabMWRacc(res = resdat, acc = accdat, type = 'individual', accchk = 'Lab Duplicates', warn = warn, caption = FALSE) %>% 
  thmsum(wd = wd, fontname = fontname)
```

`r if(rawdata){"<br>"}`

```{r, eval = rawdata}
notes(wd, fontname)
```

`r if(rawdata){"<br>"}`

`r if(rawdata){"#### Lab Spikes\n"}`

```{r, eval = rawdata}
tabMWRacc(res = resdat, acc = accdat, type = 'individual', accchk = 'Lab Spikes', warn = warn, caption = FALSE) %>% 
  thmsum(wd = wd, fontname = fontname)
```

`r if(rawdata){"<br>"}`

```{r, eval = rawdata}
notes(wd, fontname)
```

`r if(rawdata){"<br>"}`

`r if(rawdata){"#### Instrument Checks (post sampling)"}`

```{r, eval = rawdata}
tabMWRacc(res = resdat, acc = accdat, type = 'individual', accchk = 'Instrument Checks', warn = warn, caption = FALSE) %>% 
  thmsum(wd = wd, fontname = fontname)
```

`r if(rawdata){"<br>"}`

```{r, eval = rawdata}
notes(wd, fontname)
```

`r if(rawdata){"<br>"}`
