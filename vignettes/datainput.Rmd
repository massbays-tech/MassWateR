---
title: "MassWateR data input and checks"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MassWateR data input and checks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = F, 
  message = F
)
```

## Overview 

The MassWateR R package is designed to work with surface water monitoring data collected by watershed associations and citizen science groups in Massachusetts.  The package is created in collaboration with the Massachusetts Bays Estuary Partnership with funding from an EPA Exchange Network Grant. 

The objective of the package is to automate and facilitate quality control and exploratory analysis of data intended for upload to the Water Quality Exchange Network (WQX).  The functions provide a streamlined and repeatable means of 1) screening data for quality control, 2) interpreting data, and 3) creating graphics for analysis and reports to stakeholders.  The vignettes are organized around these topics. 

Three types of data can be used with the package: 

1. Water quality \emph{results} organized by sample location and date
2. Summary of data quality objectives that describe quality control \emph{accuracy} and \emph{completeness} measures for data in the results file
3. An optional file of station metadata, including location names, latitude, longitude, and additional grouping factor for sites. 

The input data should follow standard formats for the WQX network. Example files, described below, are provided with the package to demonstrate the appropriate formats. 

## Installation and data import

Install the package as follows:

```{r, eval = F}
# Enable universe(s) by massbays-tech
options(repos = c(
  massbaystech = 'https://massbays-tech.r-universe.dev',
  CRAN = 'https://cloud.r-project.org'))

# Install the package
install.packages('MassWateR')
```

Load the package in an R session after installation:

```{r}
library(MassWateR)
```

The example files for the package can be viewed by navigating to their location in the package installation. These are available as Excel files. 

The surface water quality results files: 

```{r, eval = F}
system.file('extdata/ExampleResults_final.xlsx', package = 'MassWateR')
```

The data quality objectives file for accuracy: 

```{r, eval = F}
system.file('extdata/ExampleDQOAccuracy_final.xlsx', package = 'MassWateR')
```

The data quality objectives file for completeness: 

```{r, eval = F}
system.file('extdata/ExampleDQOCompleteness_final.xlsx', package = 'MassWateR')
```

The site metadata file:

```{r, eval = F}
system.file('extdata/ExampleSites_final.xlsx', package = 'MassWateR')
```

Each of these files are available as binary RData files that can be viewed directly in R.

The surface water quality results: 

```{r}
head(exresults)
```

The data quality objectives for accuracy: 

```{r}
head(exdqoacc)
```

The data quality objectives for completeness: 

```{r}
head(exdqocom)
```

The site metadata:

```{r}
head(exsites)
```

The example files are provided to demonstrate how the functions in MassWateR are used.  In practice, alternative data files that follow the same format as the examples can be used with the functions.  There are several checks included in the data import functions to ensure the files are formatted correclty for downstream use.  These checks are described in the next section. 

## Data import and checks

The MassWateR package is developed for quality control and exploratory analysis of surface water quality data.  Before these analyses can occur, the data must be formatted correctly.  This section describes how to import data and the expectations that are checked automatically by the functions.  

### Surface water quality results

First, the surface water quality results can be imported with the `read_results()` function.  This is designed to important an Excel file external to R, run checks on the data, and provide some minor formatting for downstream quality control of exploratory analysis.  In this example, the system file `ExampleResults_final.xlsx` is imported.  In practice, the `pth` argument will point to an alternative external file in the WQX format. 

```{r, message = T}
pth <- system.file('extdata/ExampleResults_final.xlsx', package = 'MassWateR')
resdat <- read_results(pth, runchk = TRUE)
head(resdat)
```

Several checks are run automatically when the data are imported.  These checks are as follows (also vieweable from the help file for `check_results()`: 

* __Column name spelling__: Should be the following: Monitoring Location ID, Activity Type, Activity Start Date, Activity Start Time, Activity Depth/Height Measure, Activity Depth/Height Unit, Relative Depth Category, Characteristic Name, Result Value, Result Unit, Quantitation Limit, QC Reference Value, Result Measure Qualifier, Result Attribute.
* __Columns present__: All columns from the previous should be present, Result Attribute is optional
* __Activity Type__: Should be one of Field Msr/Obs, Sample-Routine, Quality Control Sample-Field Blank, Quality Control Sample-Lab Blank, Quality Control Sample-Lab Duplicate, Quality Control Sample-Lab Spike
* __Date formats__: Should be mm/dd/yyyy and parsed correctly on import
* __Time formats__: Should be HH:MM and parsed correctly on import
* __Relative Depth Category__: Should be either Surface, Bottom, < 1m / 3.3ft or blank
* __Characteristic Name__: Should be one of air temperature, water temperature, TP, TSS, DO % saturation, DO concentration, flow, gage, pH, sp conductivity, NH3, NO3, orthoP, E coli, or chlorophyll a
* __Result Value__: Should be a numeric value or a text value as AQL or BDL
* __QC Reference Value__: Any entered values should be numeric

An informative error is returned if the input data fail any of the checks.  The input data should be corrected by hand, by altering the appropriate rows or column names in the Excel file that are indicated in the error.  

Here is an example of an error that might be returned for an incorrect data entry (using the `check_results()` function, which is used inside of `read_results()`). To remedy the issue, change row 4 and 135 in the Activity Type column to Sample-Routine and Field Msr/Obs, respectively.  This must be done in the original Excel file.  Import the data again in R to verify the data are corrected.

```{r, eval = F}
pth <- 'ExampleResults_final.xlsx'
dat <- readxl::read_excel(pth)
chk <- dat
chk[4, 2] <- 'Sample'
chk[135, 2] <- 'Field'
check_results(chk)
#> Running checks on results data...
#> 
#> 	  Checking column names...
#> 	  Checking all required columns are present...
#> 	  Checking valid Activity Types...
#> Error in check_results(chk) : 
#>   	Incorrect Activity Type found: Sample, Field in row(s) 4, 135
```

Data imported with `read_results()` are also formatted to take care of a few minor issues for downstream analysis.  This formatting includes: 

* __Fix date and time inputs__: Activity Start Date is converted to YYYY-MM-DD as a date object, Activity Start Time is convered to HH:MM as a character to fix artifacts from Excel import
* __Create duplicate rows for entries in QC Reference Value__: This is done if a value is found in the QC Reference Value column by creating a “new” row with the same location, date, time, etc as the original but with an appropriate quality control entry for the Activity Type
* __Remove non-text or math symbols from Result Unit__: Values are stripped, e.g., the degree symbols for degrees C

### Data quality objectives

To use the quality control functions in MassWateR, Excel files that describe the data quality objectives for accuracy and completeness must be provided.  The system files included with the package, describe above, demonstrate the required information and format for these files.  They can be imported into R using the `read_dqoaccuracy()` and `read_dqocompleteness()` functions. The `pth` argument will point to the location of the external files on your computer.  As above, the system file included with the package is used for the example. 

```{r, message = T}
# import data quality objectives for accuracy
pth <- system.file('extdata/ExampleDQOAccuracy_final.xlsx', package = 'MassWateR')
dqoaccuracy <- read_dqoaccuracy(pth)
head(dqoaccuracy)
```

```{r, message = T}
# import data quality objectives for completeness
pth <- system.file('extdata/ExampleDQOCompleteness_final.xlsx', package = 'MassWateR')
dqocomplete <- read_dqocompleteness(pth)
head(dqocomplete)
```

Both the `read_dqoaccuracy()` and `read_dqocompleteness()` functions will run a series of checks to ensure the imported data are formatted correctly. The `check_dqoaccuracy()` and `check_dqocompletness()` functions run these checks when the `read_dqoaccuracy()` and `read_dqocompleteness()` functions are executed, respectively. The checks for each are as follows. 

Checks for accuracy: 

* __Column name spelling__: Should be the following: Parameter, uom, MDL, UQL, Value Range, Field Duplicate, Lab Duplicate, Field Blank, Lab Blank, Spike/Check Accuracy
* __Non-numeric values in MDL, UQL__: Values entered in columns MDL and UQL should be numeric
* __Unrecognized characters__: Fields describing accuracy checks should not include symbols or text other than <=, <, >=, >, ±, %, BDL, AQL, log, or all


Checks for completeness:

* __Column name spelling__: Should be the following: Parameter, Field Duplicate, Lab Duplicate, Field Blank, Lab Blank, Spike/Check Accuracy, % Completeness
* __Non-numeric values__: Values entered in columns other than the first should be numeric
* __Values outside of 0 - 100__: Values entered in columns other than the first should not be outside of 0 and 100

