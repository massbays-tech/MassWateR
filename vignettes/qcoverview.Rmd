---
title: "MassWateR quality control functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MassWateR quality control functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = F, 
  message = F
)
```

The quality control functions in MassWateR can be used once the required data are successfully imported into R (see the [previous vignette](https://massbays-tech.github.io/MassWateR/articles/datainput.html) for an overview).  The required data includes the results data file that describe the monitoring data and the data quality objective files for accuracy, frequency, and completeness.  The example data files included with the package are imported here to demonstrate how to use the quality control functions:

```{r, message = T}
library(MassWateR)

# import results data
respth <- system.file('extdata/ExampleResults_final.xlsx', package = 'MassWateR')
resdat <- read_results(respth)

# import data quality objectives for accuracy
accpth <- system.file('extdata/ExampleDQOAccuracy_final.xlsx', package = 'MassWateR')
accdat <- read_acc(accpth)

# import data quality objectives for frequency and completeness
frecompth <- system.file('extdata/ExampleDQOFrequencyCompleteness_final.xlsx', package = 'MassWateR')
frecomdat <- read_frecom(frecompth)
```

## Quality control for accuracy

## Quality control for frequency and completeness

The quality control checks for frequency and completeness are used to verify an appropriate number of quality control samples have been collected or analyzed for each parameter.  These are checks on the quantity of samples and not the values, as for the accuracy checks.  The frequency and completeness checks require results data (as in `resdat` above) and a data quality objectives file for frequency and completeness (as in `frecomdat`).  The core function that assesses completeness is `tab_completeness()` and can be used to create two different summary tables.  

The `tab_completeness()` function can be used with inputs as paths to the relevant files or as data frames returned by `read_results()` and `read_frecom()`.  For the former, the full suite of data checks can be evaluated with `runkchk = T` (default) or suppressed with `runchk = F`, as explained in the [data inputs and checks vignette](https://massbays-tech.github.io/MassWateR/articles/datainput.html).  In the latter case, downstream analyses may not work if data are formatted incorrectly.  Also note that completeness is only evaluated on parameters in the `Parameter` column in the data quality objectives completeness file.  A warning is returned if there are parameters in that column that are not found in the results file.  This warning can be suppressed by setting `warn = FALSE`. 

A summary table showing the total number of records, the total number of qualified records (those collected for data quality objective checks), and percent completeness (the difference between the two) can be created with `tab_completeness()` by setting `type = 'summary'`.  The `% Completeness` column shows cells as green or red if the required percentage of observations for completeness are present as specified in the data quality objectives file. Note that a warning message is returned indicating that the parameter `Chloride` was found in the data quality objectives file, but was not found in the results data. Completeness checks are done only on parameters that are shared between the two.  The function is also executed with the data frames from above, since they have already passed the internal checks. 

```{r, warning = T}
tab_completeness(res = resdat, frecom = frecomdat, type = 'summary')
```

A second table showing the percentage of observations in the results file that satisfy the checks (e.g., percent field duplicates, etc.) can be created with `tab_completeness()` by setting `type = 'percent'`.  As in the previous table, cells are are shown in green or red if the required percentage of observations are present for each check as specified in the data quality objectives file.

```{r, warning = T}
tab_completeness(res = resdat, frecom = frecomdat, type = 'percent')
```

The `tab_completeness()` function uses the `qc_completeness()` function internally to create the required tables.  This function creates the raw summaries of completeness from the input data.  Typically, `qc_completeness()` is not used by itself because it is used internally by `tab_completeness()`.  It is explained here to demonstrate how the raw summaries can be obtained, if desired. 

Below, the `qc_completeness()` function is executed with the data frames for the results and quality objectives file for completeness.  The warnings and checks are supressed. 

```{r, warning = T}
qc_completeness(res = resdat, frecom = frecomdat)
```

The output shows the completeness checks from the combined files in long format.  Each row applies to a specific completeness check for a parameter. The total observations (`obs`) for each parameter are also shown, which is repeated for a parameter across the rows to calculate percentages.  The `check` column shows the relevant activity type that is assessed for completeness, the `count` columns shows the number of observations that apply to the check, the `standard` shows the relevant percentage required for quality control check from the quality control objectives file, the `percent` column shows the calculated percent taken from the input data, and the `met` column shows if the standard was met by comparing if `percent` is greater than or equal to `standard`.
