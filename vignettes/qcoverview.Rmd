---
title: "MassWateR quality control functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MassWateR quality control functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = F, 
  message = F
)
```

The quality control functions in MassWateR can be used once the required data are successfully imported into R (see the [previous vignette](https://massbays-tech.github.io/MassWateR/articles/datainput.html) for an overview).  The required data includes the results data file that describe the monitoring data and the data quality objective files for accuracy, frequency, and completeness.  The example data files included with the package are imported here to demonstrate how to use the quality control functions:

```{r, message = T}
library(MassWateR)

# import results data
respth <- system.file('extdata/ExampleResults_final.xlsx', package = 'MassWateR')
resdat <- readMWRresults(respth)

# import data quality objectives for accuracy
accpth <- system.file('extdata/ExampleDQOAccuracy_final.xlsx', package = 'MassWateR')
accdat <- readMWRacc(accpth)

# import data quality objectives for frequency and completeness
frecompth <- system.file('extdata/ExampleDQOFrequencyCompleteness_final.xlsx', package = 'MassWateR')
frecomdat <- readMWRfrecom(frecompth)
```

## Quality control for accuracy

## Quality control for frequency and completeness

The quality control checks for frequency and completeness are used to verify an appropriate number of quality control samples have been collected or analyzed for each parameter.  These are checks on the quantity of samples and not the values, as for the accuracy checks.  The frequency and completeness checks require results data (as in `resdat` above) and a data quality objectives file for frequency and completeness (as in `frecomdat`).

### Frequency 

The `tabMWRfre()` function is used to create tabular results for the frequency checks for each parameter.  The function can be used with inputs as paths to the relevant files or as data frames returned by `readMWRresults()` and `read_frecom()`.  For the former, the full suite of data checks can be evaluated with `runkchk = T` (default) or suppressed with `runchk = F`, as explained in the [data inputs and checks vignette](https://massbays-tech.github.io/MassWateR/articles/datainput.html).  In the latter case, downstream analyses may not work if data are formatted incorrectly.  Also note that completeness is only evaluated on parameters in the `Parameter` column in the data quality objectives completeness file.  A warning is returned if there are parameters in that column that are not found in the results file.  This warning can be suppressed by setting `warn = FALSE`. 

The quality control tables for frequency show the number of records that apply to a given check (e.g., Lab Blank, Field Blank, etc.) relative to the number of "regular" data records (e.g., field samples or measures) for each parameter.  A summary of all frequency checks for each parameter is provided if `type = "summary"`. The function is executed with the data frames from above, since they have already passed the internal checks. 

```{r}
tabMWRfre(res = resdat, frecom = frecomdat, type = 'summary')
```

A color-coded table showing similar information as percentages for each parameter is provided if `type = "percent"`. Cells are shown as green or red if the required frequency checks are met as specified in the data quality objectives file.

```{r}
tabMWRfre(res = resdat, frecom = frecomdat, type = 'percent')
```

The `tabMWRfre()` function uses the `qcMWRfre()` function internally to create the table.  This function creates the raw summaries of frequency from the input data.  Typically, `qcMWRfre()` is not used by itself because it is used internally by `tabMWRfre()`.  It is explained here to demonstrate how the raw summaries can be obtained, if desired. 

Below, the `qcMWRfre()` function is executed with the data frames for the results and quality objectives file for frequency and completeness.  The warnings are suppressed. 

```{r, warning = T}
qcMWRfre(res = resdat, frecom = frecomdat, warn = FALSE)
```

The output shows the frequency checks from the combined files.  Each row applies to a frequency check for a parameter. The `Parameter` column shows the parameter, the `obs` column shows the total records that apply to regular activity types, the `check` column shows the relevant activity type for each frequency check, the `count` column shows the number of records that apply to a check, the `standard` column shows the relevant percentage required for the quality control check from the quality control objectives file, and the `met` column shows if the standard was met by comparing if `percent` is greater than or equal to `standard`.

### Completeness

The `tabMWRcom()` function is used to create a table that shows the completeness percentages for each parameter.  As explained in the previous section, the function can be used with inputs as paths to the relevant files or as data frames returned by `readMWRresults()` and `read_frecom()`.  

A summary table showing the number of data records, number of qualified records, and percent completeness can be created with `tabMWRcom()`.  The `% Completeness` column shows cells as green or red if the required percentage of observations for completeness are present as specified in the data quality objectives file.  The `Hit/Miss` column shows similar information but in text format, i.e., `MISS` is shown if the quality control standard for completeness is not met. The function is also executed with the data frames from above, since they have already passed the internal checks. 

```{r, warning = T}
tabMWRcom(res = resdat, frecom = frecomdat)
```

The `tabMWRcom()` function uses the `qcMWRcom()` function internally to create the table.  This function creates the raw summaries of completeness from the input data.  Typically, `qcMWRcom()` is not used by itself because it is used internally by `tabMWRcom()`.  It is explained here to demonstrate how the raw summaries can be obtained, if desired. 

Below, the `qcMWRcom()` function is executed with the data frames for the results and quality objectives file for frequency and completeness.  The warnings are suppressed. 

```{r, warning = T}
qcMWRcom(res = resdat, frecom = frecomdat, warn = FALSE)
```

The output shows the completeness checks from the combined files.  Each row applies to a completeness check for a parameter. The `datarec` and `qualrec` columns show the number of data records and qualified records, respectively. The `datarec` column specifically shows only records not for quality control by excluding those as duplicates, blanks, or spikes in the count. The `standard` column shows the relevant percentage required for the quality control check from the quality control objectives file, the `complete` column shows the calculated completeness taken from the input data, and the `met` column shows if the standard was met by comparing if `complete` is greater than or equal to `standard`.
